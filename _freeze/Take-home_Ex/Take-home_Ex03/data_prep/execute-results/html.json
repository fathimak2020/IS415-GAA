{
  "hash": "301c46827ce30edb2439f4e09ad229df",
  "result": {
    "markdown": "---\ntitle: \"OD Bus Data Preparation\"\nformat:\n  html:\n    toc: true\nexecute: \n  warning: false\n  eval: false\n  freeze: true\n  fig-retine: 3\ndate: \"2024-03-11\"\ndate-modified: \"last-modified\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, sfdep, tidyverse, tmap, spdep, knitr, leaflet)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_sf <- st_read(dsn = \"data\", layer = \"MPSZ-2019\") %>%\n  st_transform(crs = 3414)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_nov <- read_csv(\"data/origin_destination_bus_202311.csv\")\nbus_dec <- read_csv(\"data/origin_destination_bus_202312.csv\")\nbus_jan <- read_csv(\"data/origin_destination_bus_202401.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_coords <- read_csv(\"data/bus_stop.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_coords_sf <- st_as_sf(bus_coords, coords = c(\"Longitude\", \"Latitude\"), crs = 4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_coords_sf <- st_transform(bus_coords_sf, st_crs(mpsz_sf))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsg_bus_stops <- st_intersection(bus_coords_sf, mpsz_sf)\n\ntmap_mode(\"plot\")\n\ntmap_options(check.and.fix = TRUE, max.categories = 55)\n\nmpsz_plot <- tm_shape(mpsz_sf) +\n  tm_borders(lwd = 2, group = \"mpsz_borders\") +  \n  tm_layout(legend.show = FALSE)  \n\ncombined_plot <- mpsz_plot +\n  tm_shape(mpsz_sf) +\n  tm_polygons(col = \"PLN_AREA_N\", title = \"Plan Area\", group = \"mpsz_polygons\") +\n  tm_shape(sg_bus_stops) +\n  tm_dots(col = \"blue\", size = 0.1, group = \"bus_coords\") +\n  tm_layout(legend.show = FALSE)  \n\ncombined_plot\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_stop_subzone <- st_intersection(sg_bus_stops, mpsz_sf)\nsg_bus_stops$Subzone <- bus_stop_subzone$PLN_AREA_N\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_data <- merge(bus_coords, sg_bus_stops, by = \"BusStopCode\", all.x = TRUE)\nbus_coords$Subzone <- merged_data$PLN_AREA_N\nbus_coords <- bus_coords[, c(\"BusStopCode\", \"RoadName\", \"Description\", \"Subzone\", \"Latitude\", \"Longitude\")]\nbus_coords_subzone <- bus_coords\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(bus_coords_subzone, \"data/rds/bus_coords_subzone.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_nov <- left_join(bus_nov, bus_coords, by = c(\"ORIGIN_PT_CODE\" = \"BusStopCode\")) %>%\n  rename(ORIGIN_SUBZONE = Subzone, ORIGIN_DESCRIPTION = Description, ORIGIN_LAT = Latitude, ORIGIN_LONG = Longitude) %>%\n  left_join(bus_coords, by = c(\"DESTINATION_PT_CODE\" = \"BusStopCode\")) %>%\n  rename(DESTINATION_SUBZONE = Subzone, DESTINATION_DESCRIPTION = Description, DESTINATION_LAT = Latitude, DESTINATION_LONG = Longitude) %>%\n  select(YEAR_MONTH, DAY_TYPE, TIME_PER_HOUR, PT_TYPE, \n         ORIGIN_PT_CODE, ORIGIN_SUBZONE, ORIGIN_DESCRIPTION, ORIGIN_LAT, ORIGIN_LONG,\n         DESTINATION_PT_CODE, DESTINATION_SUBZONE, DESTINATION_DESCRIPTION, DESTINATION_LAT, DESTINATION_LONG,\n         TOTAL_TRIPS)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmissing_stops <- merged_bus_nov %>%\n  summarise(ORIGIN_NA = any(is.na(ORIGIN_DESCRIPTION)),\n            DESTINATION_NA = any(is.na(DESTINATION_DESCRIPTION)),\n            ORIGIN_PT_WITH_NA = ifelse(any(is.na(ORIGIN_DESCRIPTION)), unique(ORIGIN_PT_CODE[is.na(ORIGIN_DESCRIPTION)]), NA),\n            DESTINATION_PT_WITH_NA = ifelse(any(is.na(DESTINATION_DESCRIPTION)), unique(DESTINATION_PT_CODE[is.na(DESTINATION_DESCRIPTION)]), NA))\n\nprint(missing_stops)\n```\n:::\n\n\nNote: bus stop 65139 is no longer in operation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_nov <- merged_bus_nov %>%\n  filter(!is.na(ORIGIN_DESCRIPTION) & !is.na(DESTINATION_DESCRIPTION))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(merged_bus_nov, \"data/rds/merged_bus_nov.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_dec <- left_join(bus_dec, bus_coords, by = c(\"ORIGIN_PT_CODE\" = \"BusStopCode\")) %>%\n  rename(ORIGIN_SUBZONE = Subzone, ORIGIN_DESCRIPTION = Description, ORIGIN_LAT = Latitude, ORIGIN_LONG = Longitude) %>%\n  left_join(bus_coords, by = c(\"DESTINATION_PT_CODE\" = \"BusStopCode\")) %>%\n  rename(DESTINATION_SUBZONE = Subzone, DESTINATION_DESCRIPTION = Description, DESTINATION_LAT = Latitude, DESTINATION_LONG = Longitude) %>%\n  select(YEAR_MONTH, DAY_TYPE, TIME_PER_HOUR, PT_TYPE, \n         ORIGIN_PT_CODE, ORIGIN_SUBZONE, ORIGIN_DESCRIPTION, ORIGIN_LAT, ORIGIN_LONG,\n         DESTINATION_PT_CODE, DESTINATION_SUBZONE, DESTINATION_DESCRIPTION, DESTINATION_LAT, DESTINATION_LONG,\n         TOTAL_TRIPS)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmissing_stops_dec <- merged_bus_dec %>%\n  summarise(ORIGIN_NA = any(is.na(ORIGIN_DESCRIPTION)),\n            DESTINATION_NA = any(is.na(DESTINATION_DESCRIPTION)),\n            ORIGIN_PT_WITH_NA = ifelse(any(is.na(ORIGIN_DESCRIPTION)), unique(ORIGIN_PT_CODE[is.na(ORIGIN_DESCRIPTION)]), NA),\n            DESTINATION_PT_WITH_NA = ifelse(any(is.na(DESTINATION_DESCRIPTION)), unique(DESTINATION_PT_CODE[is.na(DESTINATION_DESCRIPTION)]), NA))\n\nprint(missing_stops_dec)\n```\n:::\n\n\nNote: bus stop 65139 is no longer in operation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_dec <- merged_bus_dec %>%\n  filter(!is.na(ORIGIN_DESCRIPTION) & !is.na(DESTINATION_DESCRIPTION))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(merged_bus_dec, \"data/rds/merged_bus_dec.rds\")\n```\n:::\n\n\n## January\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(bus_jan)\nhead(bus_dec)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_jan$ORIGIN_PT_CODE <- as.character(bus_jan$ORIGIN_PT_CODE)\nbus_jan$DESTINATION_PT_CODE <- as.character(bus_jan$DESTINATION_PT_CODE)\n\nmerged_bus_jan <- left_join(bus_jan, bus_coords, by = c(\"ORIGIN_PT_CODE\" = \"BusStopCode\")) %>%\n  rename(ORIGIN_SUBZONE = Subzone, ORIGIN_DESCRIPTION = Description, ORIGIN_LAT = Latitude, ORIGIN_LONG = Longitude) %>%\n  left_join(bus_coords, by = c(\"DESTINATION_PT_CODE\" = \"BusStopCode\")) %>%\n  rename(DESTINATION_SUBZONE = Subzone, DESTINATION_DESCRIPTION = Description, DESTINATION_LAT = Latitude, DESTINATION_LONG = Longitude) %>%\n  select(YEAR_MONTH, DAY_TYPE, TIME_PER_HOUR, PT_TYPE, \n         ORIGIN_PT_CODE, ORIGIN_SUBZONE, ORIGIN_DESCRIPTION, ORIGIN_LAT, ORIGIN_LONG,\n         DESTINATION_PT_CODE, DESTINATION_SUBZONE, DESTINATION_DESCRIPTION, DESTINATION_LAT, DESTINATION_LONG,\n         TOTAL_TRIPS)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmissing_stops_jan <- merged_bus_jan %>%\n  summarise(ORIGIN_NA = any(is.na(ORIGIN_DESCRIPTION)),\n            DESTINATION_NA = any(is.na(DESTINATION_DESCRIPTION)),\n            ORIGIN_PT_WITH_NA = ifelse(any(is.na(ORIGIN_DESCRIPTION)), unique(ORIGIN_PT_CODE[is.na(ORIGIN_DESCRIPTION)]), NA),\n            DESTINATION_PT_WITH_NA = ifelse(any(is.na(DESTINATION_DESCRIPTION)), unique(DESTINATION_PT_CODE[is.na(DESTINATION_DESCRIPTION)]), NA))\n\nprint(missing_stops_jan)\n```\n:::\n\n\nNote: dropping bus stop 4168 and 9022. Bus stop should be 5 digits.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_jan <- merged_bus_jan %>%\n  filter(!is.na(ORIGIN_DESCRIPTION) & !is.na(DESTINATION_DESCRIPTION))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(merged_bus_jan, \"data/rds/merged_bus_jan.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for spacetime \nnov_trip_generation_origin <- merged_bus_nov %>%\n   select(ORIGIN_PT_CODE, ORIGIN_DESCRIPTION, ORIGIN_SUBZONE, TIME_PER_HOUR, TOTAL_TRIPS, ORIGIN_LAT, ORIGIN_LONG) %>%\n  group_by(ORIGIN_PT_CODE, ORIGIN_DESCRIPTION,ORIGIN_SUBZONE, TIME_PER_HOUR, ORIGIN_LAT, ORIGIN_LONG) %>%\n  summarise(`TRIPS GENERATED` = sum(`TOTAL_TRIPS`)) %>%\n  ungroup() %>%\n  st_as_sf(coords = c(\"ORIGIN_LAT\", \"ORIGIN_LONG\"),\n           crs=4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(nov_trip_generation_origin, \"data/rds/nov_trip_generation_origin.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for spacetime \nnov_trip_generation_dest <- merged_bus_nov %>%\n   select(DESTINATION_PT_CODE, DESTINATION_DESCRIPTION, DESTINATION_SUBZONE, TIME_PER_HOUR, TOTAL_TRIPS, DESTINATION_LAT, DESTINATION_LONG) %>%\n  group_by(DESTINATION_PT_CODE, DESTINATION_DESCRIPTION,DESTINATION_SUBZONE, TIME_PER_HOUR, DESTINATION_LAT, DESTINATION_LONG) %>%\n  summarise(`TRIPS GENERATED` = sum(`TOTAL_TRIPS`)) %>%\n  ungroup() %>%\n  st_as_sf(coords = c(\"DESTINATION_LAT\", \"DESTINATION_LONG\"),\n           crs=4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(nov_trip_generation_dest, \"data/rds/nov_trip_generation_dest.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for spacetime \ndec_trip_generation_origin <- merged_bus_dec %>%\n   select(ORIGIN_PT_CODE, ORIGIN_DESCRIPTION, ORIGIN_SUBZONE, TIME_PER_HOUR, TOTAL_TRIPS, ORIGIN_LAT, ORIGIN_LONG) %>%\n  group_by(ORIGIN_PT_CODE, ORIGIN_DESCRIPTION,ORIGIN_SUBZONE, TIME_PER_HOUR, ORIGIN_LAT, ORIGIN_LONG) %>%\n  summarise(`TRIPS GENERATED` = sum(`TOTAL_TRIPS`)) %>%\n  ungroup() %>%\n  st_as_sf(coords = c(\"ORIGIN_LAT\", \"ORIGIN_LONG\"),\n           crs=4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(dec_trip_generation_origin, \"data/rds/dec_trip_generation_origin.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for spacetime \ndec_trip_generation_dest <- merged_bus_dec %>%\n   select(DESTINATION_PT_CODE, DESTINATION_DESCRIPTION, DESTINATION_SUBZONE, TIME_PER_HOUR, TOTAL_TRIPS, DESTINATION_LAT, DESTINATION_LONG) %>%\n  group_by(DESTINATION_PT_CODE, DESTINATION_DESCRIPTION,DESTINATION_SUBZONE, TIME_PER_HOUR, DESTINATION_LAT, DESTINATION_LONG) %>%\n  summarise(`TRIPS GENERATED` = sum(`TOTAL_TRIPS`)) %>%\n  ungroup() %>%\n  st_as_sf(coords = c(\"DESTINATION_LAT\", \"DESTINATION_LONG\"),\n           crs=4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(dec_trip_generation_dest, \"data/rds/dec_trip_generation_dest.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for spacetime \njan_trip_generation_origin <- merged_bus_jan %>%\n   select(ORIGIN_PT_CODE, ORIGIN_DESCRIPTION, ORIGIN_SUBZONE, TIME_PER_HOUR, TOTAL_TRIPS, ORIGIN_LAT, ORIGIN_LONG) %>%\n  group_by(ORIGIN_PT_CODE, ORIGIN_DESCRIPTION,ORIGIN_SUBZONE, TIME_PER_HOUR, ORIGIN_LAT, ORIGIN_LONG) %>%\n  summarise(`TRIPS GENERATED` = sum(`TOTAL_TRIPS`)) %>%\n  ungroup() %>%\n  st_as_sf(coords = c(\"ORIGIN_LAT\", \"ORIGIN_LONG\"),\n           crs=4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(jan_trip_generation_origin, \"data/rds/jan_trip_generation_origin.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# for spacetime \njan_trip_generation_dest <- merged_bus_jan %>%\n   select(DESTINATION_PT_CODE, DESTINATION_DESCRIPTION, DESTINATION_SUBZONE, TIME_PER_HOUR, TOTAL_TRIPS, DESTINATION_LAT, DESTINATION_LONG) %>%\n  group_by(DESTINATION_PT_CODE, DESTINATION_DESCRIPTION,DESTINATION_SUBZONE, TIME_PER_HOUR, DESTINATION_LAT, DESTINATION_LONG) %>%\n  summarise(`TRIPS GENERATED` = sum(`TOTAL_TRIPS`)) %>%\n  ungroup() %>%\n  st_as_sf(coords = c(\"DESTINATION_LAT\", \"DESTINATION_LONG\"),\n           crs=4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#write_rds(jan_trip_generation_dest, \"data/rds/jan_trip_generation_dest.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_nov <- read_rds(\"data/rds/merged_bus_nov.rds\")\nwrite.csv(merged_bus_nov, file = \"data/merged_bus_nov.csv\", row.names = FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_dec <- read_rds(\"data/rds/merged_bus_dec.rds\")\nwrite.csv(merged_bus_dec, file = \"data/merged_bus_dec.csv\", row.names = FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged_bus_jan <- read_rds(\"data/rds/merged_bus_jan.rds\")\nwrite.csv(merged_bus_jan, file = \"data/merged_bus_jan.csv\", row.names = FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbus_coords_subzone <- read_rds(\"data/rds/bus_coords_subzone.rds\")\nwrite.csv(bus_coords_subzone, file = \"data/bus_coords_subzone.csv\", row.names = FALSE)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}